# 飞书集成

WeTrace 支持与飞书深度集成，通过飞书机器人推送告警消息卡片，或将告警记录写入飞书多维表格。本文档介绍飞书集成的完整配置流程。

---

## 1. 进入飞书配置

在左侧导航栏点击「监控配置」，页面下方即为「飞书平台配置」卡片。

---

## 2. 启用飞书推送

在「飞书平台配置」卡片中，打开「启用飞书推送」开关。启用后会展开详细配置选项。

---

## 3. 选择推送方式

启用后首先选择推送方式，提供三个选项：

| 推送方式 | 说明 |
|---------|------|
| 机器人 | 仅通过飞书机器人 Webhook 推送消息卡片 |
| 多维表格 | 仅将告警记录写入飞书多维表格 |
| 两者都用 | 同时推送机器人消息和写入多维表格 |

点击对应按钮切换推送方式。

---

## 4. 机器人推送配置

选择「机器人」或「两者都用」时，会展开机器人推送配置区域。

### 4.1 获取飞书机器人 Webhook URL

1. 打开飞书，进入目标群聊
2. 点击群聊右上角的设置图标
3. 选择「群机器人」>「添加机器人」
4. 选择「自定义机器人」
5. 填写机器人名称和描述
6. 复制生成的 Webhook URL（格式：`https://open.feishu.cn/open-apis/bot/v2/hook/xxx`）

### 4.2 填写配置

在 WeTrace 的机器人推送配置区域：

- **机器人 Webhook URL**：粘贴上一步复制的 Webhook 地址
- **签名密钥（可选）**：如果在飞书机器人设置中开启了「签名校验」，将签名密钥填入此处

签名校验的工作原理：WeTrace 使用 HMAC-SHA256 算法，将当前时间戳和签名密钥组合生成签名，附加到每次推送请求中。飞书服务端会验证签名的有效性，防止非法调用。

### 4.3 测试机器人连通性

配置完成后，点击「测试机器人」按钮：

- 测试时按钮显示加载动画
- 成功后显示绿色对勾图标，同时飞书群聊中会收到一条蓝色卡片消息，标题为「WeTrace 连通性测试」
- 失败后显示红色叉号图标，请检查 Webhook URL 是否正确

---

## 5. 多维表格配置

选择「多维表格」或「两者都用」时，会展开多维表格推送配置区域。

### 5.1 创建飞书应用

1. 访问飞书开放平台（open.feishu.cn），登录后进入「开发者后台」
2. 点击「创建企业自建应用」
3. 填写应用名称和描述，创建完成后记录 App ID 和 App Secret

### 5.2 配置应用权限

在飞书开放平台的应用管理页面：

1. 进入「权限管理」
2. 搜索并添加以下权限：
   - `bitable:app` — 多维表格应用权限
   - `bitable:app:readonly` — 多维表格只读权限（用于连通性测试）
3. 发布应用版本并等待管理员审批通过

### 5.3 创建多维表格

1. 在飞书中创建一个新的多维表格
2. 在表格中创建以下字段：

| 字段名 | 字段类型 | 说明 |
|--------|---------|------|
| 发送人 | 文本 | 消息发送人昵称 |
| 会话 | 文本 | 会话名称 |
| 消息内容 | 文本 | 触发告警的消息内容 |
| 触发规则 | 文本 | 命中的监控规则名称和匹配信息 |
| 消息时间 | 文本 | 消息的原始发送时间 |
| 告警时间 | 文本 | WeTrace 发送告警的时间 |

3. 从多维表格的浏览器地址栏中获取 App Token 和 Table ID：
   - 地址格式：`https://xxx.feishu.cn/base/{app_token}?table={table_id}`
   - `{app_token}` 即为 App Token
   - `{table_id}` 即为 Table ID

### 5.4 填写配置

在 WeTrace 的多维表格推送配置区域，填写以下信息：

- **App ID**：飞书应用的 App ID
- **App Secret**：飞书应用的 App Secret
- **多维表格 App Token**：从表格地址栏获取的 app_token
- **数据表 Table ID**：从表格地址栏获取的 table_id

### 5.5 测试多维表格连通性

配置完成后，点击「测试多维表格」按钮：

- 测试时按钮显示加载动画
- 系统会先通过 App ID 和 App Secret 获取 tenant_access_token
- 然后尝试读取多维表格的一条记录来验证连通性
- 成功后显示绿色对勾图标
- 失败后显示红色叉号图标

常见失败原因：
- App ID 或 App Secret 错误
- 应用未获得多维表格权限
- App Token 或 Table ID 不正确
- 应用未发布或未审批通过

---

## 6. 保存配置

所有飞书配置填写完成后，点击「保存配置」按钮。配置会持久化到本地 `data/monitor_configs.json` 文件中，应用重启后自动加载。

---

## 7. 告警消息格式

### 7.1 机器人卡片消息

当监控规则触发告警时，飞书群聊中会收到一条红色主题的交互式卡片消息，包含以下信息：

- 标题：「WeTrace 消息监控告警」
- 发送人：消息发送者昵称
- 会话：所属会话名称
- 消息内容：触发告警的消息原文
- 触发规则：规则名称和匹配详情

### 7.2 多维表格记录

告警同时会在多维表格中新增一行记录，字段对应关系：

| 表格字段 | 内容 |
|---------|------|
| 发送人 | 消息发送者昵称 |
| 会话 | 会话名称 |
| 消息内容 | 触发告警的消息原文 |
| 触发规则 | 规则名称 + 匹配信息 |
| 消息时间 | 消息的原始发送时间 |
| 告警时间 | WeTrace 处理告警的时间 |

---

## 8. 常见问题

**Q: 机器人推送和多维表格推送可以同时使用吗？**

A: 可以。选择「两者都用」推送方式即可，每次告警会同时发送机器人卡片消息和写入多维表格记录。

**Q: tenant_access_token 会过期吗？**

A: 会。飞书的 tenant_access_token 有效期约 2 小时。WeTrace 内部会自动缓存 token 并在过期前 60 秒自动刷新，无需手动干预。

**Q: 监控规则中的飞书 URL 和全局飞书配置有什么关系？**

A: 每条监控规则可以单独配置飞书 Webhook URL。如果规则中未配置，系统会回退使用全局飞书配置中的机器人 Webhook URL。多维表格推送始终使用全局配置。

**Q: 飞书机器人消息发送失败怎么排查？**

A: 请依次检查：
1. Webhook URL 是否正确且未过期
2. 如果启用了签名校验，签名密钥是否与飞书后台一致
3. 网络是否能访问 `open.feishu.cn`
4. 使用「测试机器人」按钮验证连通性
