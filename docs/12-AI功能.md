# AI 功能

WeTrace 集成了多项基于大语言模型的 AI 功能，包括对话摘要、待办提取、关键信息抽取、模拟聊天、情感分析，以及灵活的 AI 配置与自定义提示词管理。使用 AI 功能前，需要先在设置页面完成 AI 配置。

## AI 配置

### 进入配置

在左侧导航栏点击「设置」，页面顶部即为「AI 大模型配置」卡片。

### 启用 AI

通过「启用 AI 功能」开关控制 AI 功能的全局启停。关闭后，所有 AI 相关功能入口将不可用。

### 配置提供商

启用 AI 后，需要填写以下配置项：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| 提供商 | AI 服务提供商标识 | `openai` / `deepseek` / `custom` |
| 模型名称 | 使用的模型 ID | `gpt-4o` / `deepseek-chat` |
| API 地址 | 服务端点 URL | `https://api.openai.com/v1` |
| API Key | 认证密钥 | 以 `sk-` 开头的密钥字符串 |

填写完成后点击「保存配置」按钮保存。

### 测试连接

保存配置后，点击「测试连接」按钮验证 AI 服务是否可用：

- 测试中：按钮显示加载动画
- 测试成功：按钮前出现绿色对勾图标
- 测试失败：按钮前出现红色叉号图标

如果测试失败，请检查 API 地址、密钥是否正确，以及网络是否可达。

## 自定义提示词

点击 AI 配置卡片中的「修改默认提示词」按钮，打开提示词配置弹窗。系统提供 6 种提示词模板，通过顶部标签页切换：

| 模板名称 | 用途 |
|----------|------|
| 聊天总结 | 用于 AI 摘要功能的提示词 |
| 模拟对话 | 用于 AI 模拟聊天的提示词，支持 `{{target_name}}` 和 `{{history}}` 变量 |
| 情感分析 | 用于 AI 情感分析的提示词，支持 `{{monthly_texts}}` 变量 |
| 结构化摘要 | 用于长对话/群聊摘要的提示词 |
| 待办提取 | 用于从聊天中提取待办事项的提示词 |
| 关键信息抽取 | 用于提取地址、时间等关键信息的提示词，支持 `{{types_hint}}` 变量 |

操作说明：

1. 点击标签页切换到目标模板
2. 在文本框中编辑提示词内容，留空则使用系统默认值
3. 如需恢复默认，点击右上角「重置默认」按钮
4. 编辑完成后点击「保存提示词」按钮保存所有修改

## AI 工具箱

在左侧导航栏点击「AI 工具箱」进入。页面包含三个标签页：对话摘要、待办提取、关键信息。所有标签页共享顶部的会话选择器和时间范围选择器。

### 通用操作：选择会话与时间范围

1. 在「选择会话」搜索框中输入联系人或群聊名称
2. 从下拉列表中点击选择目标会话，选中后显示「已选择: xxx」
3. 在「时间范围」区域选择预设范围：最近一周 / 最近一月 / 最近一年

### AI 摘要

切换到「对话摘要」标签页，点击「生成对话摘要」按钮。系统会读取所选会话在指定时间范围内的文本消息（最多 500 条），交由 AI 生成一段结构化的对话摘要。

生成完成后，摘要内容以卡片形式展示，标题为「与 xxx 的对话摘要」。摘要通常包含对话的主要话题、关键讨论点和结论。

### AI 待办提取

切换到「待办提取」标签页，点击「提取待办事项」按钮。系统会读取所选会话在指定时间范围内的文本消息（最多 300 条，默认最近一周），由 AI 识别其中的待办事项。

提取结果以卡片列表展示，每条待办包含：

- 序号编号
- 待办内容描述
- 优先级标签：高（红色）/ 中（黄色）/ 低（绿色）
- 截止日期（如有）
- 原文引用：触发该待办的原始消息内容

如果未发现待办事项，页面会显示「未发现待办事项」的空状态提示。

### AI 关键信息提取

切换到「关键信息」标签页，点击「提取关键信息」按钮。系统会读取所选会话在指定时间范围内的文本消息（最多 300 条，默认最近一个月），由 AI 识别以下四类关键信息：

| 类型 | 图标颜色 | 说明 |
|------|----------|------|
| 地址 | 蓝色 | 聊天中提到的地点、地址信息 |
| 时间 | 琥珀色 | 约定的时间、日期安排 |
| 金额 | 绿色 | 涉及的金额、费用信息 |
| 电话 | 紫色 | 出现的电话号码 |

每条提取结果以卡片展示，包含信息类型标签、提取的值、出现时间以及原文上下文。如果未发现关键信息，页面会显示「未发现关键信息」的空状态提示。

## AI 模拟聊天

AI 模拟聊天功能基于历史聊天记录学习对方的语言风格，模拟对方的回复方式。该功能仅限个人聊天（非群聊）使用。

### 使用方式

1. 在聊天界面中打开与某位联系人的对话
2. 进入模拟聊天入口
3. 输入你想发送的消息
4. AI 会基于最近 150 条历史聊天记录，学习对方的用词习惯、语气和表达方式
5. 生成一条模拟对方风格的回复

### 工作原理

系统会从数据库中读取最多 300 条历史消息，取最近的 150 条作为上下文。AI 会分析对方在历史对话中的语言特征，包括常用词汇、句式长度、表情符号使用习惯等，然后以对方的风格生成回复。

> 注意：模拟聊天仅用于娱乐和参考，生成的回复不代表对方的真实想法。

## AI 情感分析

情感分析功能通过 AI 对聊天记录进行情绪倾向分析，评估双方的关系健康度和情感变化趋势。该功能仅支持个人聊天（自动过滤群聊会话）。

### 进入情感分析

在左侧导航栏点击「情感分析」进入。

### 操作步骤

1. 在「选择聊天对象」搜索框中输入联系人名称（仅显示个人聊天，不包含群聊）
2. 从下拉列表中点击选择目标联系人
3. 可选设置「开始日期」和「结束日期」限定分析范围，留空则分析全部历史记录
4. 点击「开始情感分析」按钮，等待 AI 分析完成

### 分析结果

分析完成后，页面展示以下几个部分：

#### 情感评分卡片

页面顶部展示一张渐变背景的总评卡片，包含：

- 情感评分（0-100 分）：以圆形仪表盘展示，分数越高表示情感越积极
  - 60 分以上：绿色笑脸图标，表示积极
  - 40-60 分：黄色中性图标，表示一般
  - 40 分以下：红色皱眉图标，表示消极
- 情感标签：如「积极」「中性」「消极」等文字描述
- 关系健康度：对双方关系状态的整体评估

#### AI 分析总结

评分卡片下方展示一段 AI 生成的文字总结，概述双方对话的整体情感倾向、互动特点和关系状态。

#### 情感分布饼图

以环形饼图展示对话中三种情感的占比：

- 积极（绿色）：正面、愉快、鼓励性质的对话占比
- 中性（灰色）：日常、事务性对话占比
- 消极（红色）：负面、不满、争执性质的对话占比

饼图下方以图例形式显示每种情感的百分比数值。

#### 关系指标

与情感分布饼图并排展示的关系指标卡片，包含三项数据：

- **主动发起比例**：以进度条展示你在对话中主动发起聊天的比例（0-100%），比例越高说明你越主动
- **回复速度**：AI 对双方回复速度的评估描述（如「较快」「一般」「较慢」）
- **亲密度趋势**：AI 对关系亲密度变化方向的判断（如「上升」「稳定」「下降」）

#### 情感时间线

页面底部展示情绪变化趋势折线图，按月份追踪情感得分的变化：

- 横轴为月份（如 2024-01、2024-02）
- 纵轴为情感得分（0-100）
- 折线图上每个数据点代表该月的情感评分

折线图下方还展示每个月份的详细信息列表：

- 月份标识
- 情感标签（以彩色标签展示：绿色=积极、黄色=中性、红色=消极）
- 关键词列表：该月对话中的代表性关键词，以灰色标签展示

### 数据采样方式

情感分析采用按月分段采样的方式处理聊天记录。系统会将指定时间范围按月划分，每月最多采样 100 条文本消息，确保在长时间跨度下也能高效分析，同时覆盖各个时间段的对话特征。

## 常见问题

**Q: AI 功能提示「AI 功能未启用」怎么办？**
A: 请前往「设置」页面，开启「启用 AI 功能」开关，并正确填写提供商、模型、API 地址和 API Key，保存后即可使用。

**Q: AI 分析结果不准确怎么办？**
A: AI 分析结果受模型能力和聊天内容影响。你可以尝试更换更强的模型（如 gpt-4o），或通过「修改默认提示词」功能优化提示词以获得更好的分析效果。

**Q: 支持哪些 AI 提供商？**
A: 系统兼容所有提供 OpenAI Chat Completions API 格式的服务，包括 OpenAI、DeepSeek 以及任何兼容该接口格式的自定义服务。只需填写对应的 API 地址和密钥即可。
