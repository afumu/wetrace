# 系统设置

WeTrace 提供多项系统级配置，包括密码保护、语音转文字、联系人提醒和合规协议。本文档介绍各项设置的配置方法。

---

## 1. 密码保护

密码保护功能可以为 WeTrace 添加访问密码，每次打开应用时需要输入密码才能使用。

### 1.1 进入配置

在左侧导航栏点击「设置」，找到「密码保护」卡片。

### 1.2 启用密码保护

当密码保护未开启时：

1. 在「设置新密码」输入框中输入密码（至少 4 位）
2. 在「确认密码」输入框中再次输入相同密码
3. 点击「启用密码保护」按钮
4. 设置成功后提示「密码已设置」

密码要求：
- 最少 4 位字符
- 两次输入必须一致
- 密码使用 bcrypt 算法加密存储，不保存明文

### 1.3 关闭密码保护

当密码保护已开启时：

1. 在「输入当前密码以关闭保护」输入框中输入当前密码
2. 点击「关闭密码保护」按钮（红色）
3. 验证通过后提示「密码保护已关闭」
4. 密码哈希会从配置中清除

### 1.4 修改密码

修改密码需要先关闭密码保护，再重新设置新密码。也可以通过 API 接口 `POST /api/password/set` 直接修改，需要提供旧密码和新密码。

### 1.5 解锁流程

启用密码保护后，每次打开 WeTrace 时：

1. 系统检测到密码已设置且当前会话未验证
2. 界面显示密码输入框
3. 用户输入密码后，系统使用 bcrypt 验证
4. 验证通过后生成 32 字节随机 token 作为会话凭证
5. Token 通过 Cookie（`auth_token`，有效期 24 小时）和响应体同时返回
6. 后续请求通过 `X-Auth-Token` 请求头或 Cookie 携带 token

---

## 2. 语音转文字（Whisper）

语音转文字功能可以将微信语音消息转换为文字，方便阅读和搜索。

### 2.1 进入配置

在左侧导航栏点击「设置」，找到「语音转文字 (Whisper)」卡片。

### 2.2 启用语音转文字

打开「启用语音转文字」开关，展开详细配置选项。

### 2.3 配置参数

启用后需要填写以下配置：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| 提供商 | 语音识别服务提供商 | `openai` |
| 模型名称 | 使用的语音识别模型 | `whisper-1` |
| API 地址 | 服务端点 URL | `https://api.openai.com/v1` |
| API Key | 服务认证密钥 | 输入后以密文显示 |

填写完成后点击「保存配置」按钮。

### 2.4 使用方式

配置完成后，在聊天记录中遇到语音消息时，消息旁边会出现「转文字」按钮。点击按钮即可将该条语音消息发送到 Whisper API 进行识别，识别结果会显示在语音消息下方。

### 2.5 兼容性说明

语音转文字功能支持所有兼容 OpenAI Whisper API 格式的服务端点，包括：

- OpenAI 官方 API
- 自部署的 Whisper 服务（如 faster-whisper-server）
- 其他兼容 OpenAI 接口格式的第三方服务

### 2.6 配置持久化

语音转文字配置涉及以下配置项：

| 配置项 | 说明 |
|--------|------|
| `TTS_ENABLED` | 是否启用语音转文字 |
| `TTS_PROVIDER` | 服务提供商 |
| `TTS_BASE_URL` | API 地址 |
| `TTS_API_KEY` | API 密钥 |
| `TTS_MODEL` | 模型名称 |

---

## 3. 联系人提醒

联系人提醒功能帮助用户发现长时间未联系的客户，及时跟进维护关系。

### 3.1 进入页面

在左侧导航栏点击「联系提醒」进入联系人提醒页面。

### 3.2 选择提醒天数

页面顶部提供 5 个预设的天数选项：

| 选项 | 说明 |
|------|------|
| 3天 | 显示超过 3 天未联系的客户 |
| 7天 | 显示超过 7 天未联系的客户（默认） |
| 15天 | 显示超过 15 天未联系的客户 |
| 30天 | 显示超过 30 天未联系的客户 |
| 60天 | 显示超过 60 天未联系的客户 |

点击对应按钮切换筛选条件，列表会自动刷新。

### 3.3 搜索联系人

在搜索框中输入关键词，可以按昵称、备注或微信号过滤联系人列表。

### 3.4 联系人卡片信息

每个联系人卡片显示以下信息：

- 头像
- 显示名称（优先显示备注，其次昵称，最后微信号）
- 如果备注和昵称不同，会在名称后括号显示昵称
- 最后联系日期
- 未联系天数（颜色编码）

未联系天数的颜色含义：

| 天数范围 | 颜色 | 紧急程度 |
|---------|------|---------|
| 15 天以内 | 灰色 | 一般 |
| 15-29 天 | 黄色 | 需关注 |
| 30-59 天 | 橙色 | 较紧急 |
| 60 天以上 | 红色 | 紧急 |

页面顶部还会显示符合条件的客户总数。

---

## 4. 合规协议

WeTrace 在首次使用时要求用户同意合规协议，确认数据使用的合法性。

### 4.1 首次使用

首次启动 WeTrace 时，系统会检查合规同意状态。如果用户尚未同意，界面会弹出合规协议对话框，用户必须同意后才能继续使用。

### 4.2 同意流程

1. 系统通过 `GET /api/compliance` 接口检查当前同意状态
2. 如果 `agreed` 为 `false`，前端展示合规协议内容
3. 用户阅读并点击「同意」按钮
4. 前端调用 `POST /api/compliance/agree` 提交同意
5. 系统记录同意时间和协议版本号

### 4.3 存储的信息

合规同意状态通过以下配置项持久化：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| `COMPLIANCE_AGREED` | 是否已同意 | `true` |
| `COMPLIANCE_AGREED_AT` | 同意时间（RFC3339 格式） | `2025-01-15T10:30:00+08:00` |
| `COMPLIANCE_VERSION` | 协议版本号 | `1.0` |

同意后不会再次弹出协议对话框，除非协议版本更新。
