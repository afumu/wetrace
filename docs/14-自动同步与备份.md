# 自动同步与备份

WeTrace 提供自动同步和自动备份两项功能，帮助用户保持数据最新并定期导出聊天记录。两项功能均可在「设置」页面进行配置。

---

## 1. 自动同步

自动同步功能会定期从微信数据源重新读取并更新 WeTrace 中的聊天数据，确保分析结果基于最新的消息记录。

### 1.1 进入配置

在左侧导航栏点击「设置」，找到「自动同步」卡片。

### 1.2 启用/禁用

- 在「自动同步」卡片中，找到「启用自动同步」开关
- 打开开关即启用自动同步，关闭则停止定时同步任务
- 修改后点击「保存配置」按钮使设置生效

### 1.3 设置同步间隔

启用自动同步后，会出现「同步间隔（分钟）」输入框：

- 最小值：5 分钟
- 最大值：1440 分钟（24 小时）
- 默认值：30 分钟

输入期望的间隔时间后，点击「保存配置」。系统会按照设定的间隔自动执行同步操作。

### 1.4 手动触发同步

无论是否启用自动同步，都可以随时点击「立即同步」按钮手动触发一次同步操作。

- 点击后按钮会显示加载动画，表示同步正在进行
- 如果当前已有同步任务在运行，系统会返回「already_syncing」状态，不会重复执行
- 同步在后台异步执行，不会阻塞界面操作

### 1.5 查看同步状态

「自动同步」卡片底部会显示：

- **上次同步时间**：最近一次同步完成的时间
- **同步状态**：`success`（成功）或 `failed`（失败）
- **同步中指示**：如果当前正在同步，界面会自动每 2 秒刷新状态

### 1.6 配置持久化

同步配置会通过 viper 持久化到配置文件，涉及以下配置项：

| 配置项 | 说明 |
|--------|------|
| `SYNC_ENABLED` | 是否启用自动同步 |
| `SYNC_INTERVAL_MINUTES` | 同步间隔（分钟） |

---

## 2. 自动备份

自动备份功能会定期将聊天记录导出为指定格式的文件，便于归档和离线查看。

### 2.1 进入配置

在左侧导航栏点击「设置」，找到「自动备份」卡片。

### 2.2 启用/禁用

- 在「自动备份」卡片中，找到「启用自动备份」开关
- 打开开关后需要配置备份路径才能正常工作
- 启用备份时如果未指定备份路径，系统会提示错误
- 修改后点击「保存配置」按钮使设置生效

### 2.3 设置备份间隔

启用自动备份后，会出现「备份间隔（小时）」输入框：

- 最小值：1 小时
- 默认值：24 小时
- 输入期望的间隔后点击「保存配置」

### 2.4 设置备份保存路径

在「备份保存路径」输入框中填写备份文件的存储目录，例如：

```
D:\WeTrace备份
```

该目录如果不存在，系统会在备份时自动创建。

### 2.5 选择备份格式

在「备份格式」输入框中填写导出格式，支持以下三种：

| 格式 | 说明 |
|------|------|
| `html` | HTML 格式，带样式排版，适合浏览器查看（默认） |
| `txt` | 纯文本格式，体积小，适合归档 |
| `csv` | CSV 表格格式，适合导入 Excel 等工具分析 |

### 2.6 手动触发备份

在「自动备份」卡片底部的「手动备份范围」区域，可以选择备份范围并手动触发：

**备份所有会话：**

1. 选择「备份所有会话」单选按钮（默认选中）
2. 点击「立即备份全部」按钮
3. 系统会在后台异步执行备份，界面提示「备份任务已启动」

**备份指定会话：**

1. 选择「选择会话备份」单选按钮
2. 在会话列表中勾选需要备份的会话（支持搜索过滤）
3. 可使用「全选」和「取消全选」按钮快速操作
4. 列表上方会显示已选择的会话数量
5. 点击「立即备份 (N)」按钮（N 为已选数量）
6. 至少需要选择一个会话才能执行备份

### 2.7 查看备份状态

「自动备份」卡片会显示：

- **上次备份时间**：最近一次备份完成的时间
- **备份状态**：`success`（成功）或 `failed`（失败）

### 2.8 查看备份历史

通过 API 接口 `GET /api/backup/history` 可以查询备份历史记录，支持分页参数：

- `limit`：每页记录数（默认 20）
- `offset`：偏移量

每条备份记录包含以下信息：

| 字段 | 说明 |
|------|------|
| `id` | 备份 ID（格式：`backup_20060102_150405`） |
| `time` | 备份执行时间 |
| `status` | 状态（`success` / `failed`） |
| `file_path` | 备份文件路径 |
| `file_size` | 文件大小（字节） |
| `sessions_count` | 备份的会话数量 |
| `error_msg` | 失败时的错误信息 |

备份历史会持久化到本地 JSON 文件，应用重启后仍可查看。

### 2.9 配置持久化

备份配置会通过 viper 持久化到配置文件，涉及以下配置项：

| 配置项 | 说明 |
|--------|------|
| `BACKUP_ENABLED` | 是否启用自动备份 |
| `BACKUP_INTERVAL_HOURS` | 备份间隔（小时） |
| `BACKUP_PATH` | 备份保存路径 |
| `BACKUP_FORMAT` | 备份格式（html/txt/csv） |

---

## 3. 常见问题

**Q: 同步和备份有什么区别？**

A: 同步是将微信最新数据读入 WeTrace 系统中供分析使用；备份是将 WeTrace 中的聊天记录导出为独立文件，用于归档或离线查看。

**Q: 同步间隔设置多少合适？**

A: 如果需要实时跟踪聊天动态，建议设置 5-10 分钟；如果只是日常使用，30 分钟或更长即可。间隔越短，系统资源消耗越大。

**Q: 备份文件存储在哪里？**

A: 备份文件存储在配置的备份路径下，按时间戳命名（格式：`backup_YYYYMMDD_HHMMSS`），每次备份生成独立的文件。

**Q: 手动备份时可以不配置自动备份吗？**

A: 可以。手动备份功能不依赖自动备份的启用状态，但需要在配置中设置好备份路径和格式。
