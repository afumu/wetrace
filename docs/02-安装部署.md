# 安装部署

## 环境要求

| 依赖项 | 最低版本 | 说明 |
|--------|---------|------|
| Go | 1.24+ | 后端编译 |
| gcc | - | go-sqlite3 需要 CGO 编译 |
| Node.js | 18+ | 前端编译 |
| npm | 9+ | 前端包管理 |
| 操作系统 | Windows / macOS / Linux | 密钥提取功能仅支持 Windows |

> **注意**：密钥自动提取（DLL 注入获取 DB Key）功能目前仅支持 Windows。macOS 和 Linux 可以运行 Web 服务，但需要手动提供密钥。

## 从源码编译

### 1. 克隆项目

```bash
git clone https://github.com/afumu/wetrace.git
cd wetrace
```

### 2. 编译前端

```bash
cd ui
npm install
npm run build
```

编译完成后，静态资源会输出到 `ui/dist` 目录。Go 后端通过 `go:embed` 将该目录嵌入到最终二进制文件中。

### 3. 编译后端

```bash
# 回到项目根目录
cd ..

# Windows
CGO_ENABLED=1 go build -o wetrace.exe main.go

# macOS / Linux
CGO_ENABLED=1 go build -o wetrace main.go
```

> `CGO_ENABLED=1` 是必须的，因为 `go-sqlite3` 依赖 CGO 编译。请确保系统已安装 gcc。

### 4. 跨平台打包（可选）

项目提供了跨平台打包脚本，可一次性生成多平台二进制：

```bash
bash script/package.sh
```

打包产物输出到 `packages/` 目录，包含各平台的压缩包和 SHA256 校验文件。

## 启动运行

### 直接运行

```bash
# Windows
wetrace.exe

# macOS / Linux
./wetrace
```

程序启动后会：

1. 读取当前目录下的 `.env` 配置文件（不存在则自动创建）
2. 创建 `data/` 工作目录（用于存放解密后的数据库）
3. 启动 Web 服务
4. 自动打开默认浏览器访问界面

### 默认访问地址

```
http://127.0.0.1:5200
```

可通过 `.env` 文件中的 `LISTEN_ADDR` 或 `PORT` 配置项修改监听地址和端口，详见 [配置说明](03-配置说明.md)。

### Docker 部署

项目提供了 Docker 入口脚本 `script/docker-entrypoint.sh`，支持通过环境变量 `PUID` / `PGID` 设置运行用户：

```bash
docker run -d \
  -p 5200:5200 \
  -v /path/to/data:/app/data \
  -e PUID=1000 \
  -e PGID=1000 \
  wetrace
```

## 开发模式

前后端可以分别独立运行，方便开发调试。

### 前端开发

```bash
cd ui
npm install
npm run dev
```

前端开发服务器默认运行在 `http://localhost:5173`，需要将 API 请求代理到后端服务。

### 后端开发

```bash
CGO_ENABLED=1 go run main.go
```

后端默认监听 `127.0.0.1:5200`。

## 常见问题

### 编译报错：gcc not found

`go-sqlite3` 依赖 CGO，需要安装 C 编译器：

- **Windows**：安装 [MinGW-w64](https://www.mingw-w64.org/) 或 [TDM-GCC](https://jmeubank.github.io/tdm-gcc/)，并将 `bin` 目录加入 `PATH`
- **macOS**：运行 `xcode-select --install`
- **Linux**：运行 `sudo apt install build-essential`（Debian/Ubuntu）或 `sudo yum groupinstall "Development Tools"`（CentOS）
