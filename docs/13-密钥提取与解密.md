# 密钥提取与解密

WeTrace 需要获取微信的数据库密钥和图片密钥才能解密并分析聊天数据。本文档介绍密钥提取的完整流程和数据库解密操作。

## 概述

WeTrace 涉及两类密钥：

| 密钥类型 | 用途 | 获取方式 |
|---------|------|---------|
| 数据库密钥（DB Key） | 解密微信 SQLite 数据库文件 | DLL 注入 + Hook 拦截 |
| 图片密钥（Image Key） | 解密微信缓存的加密图片 | 内存扫描 + 模板文件分析 |

---

## 1. 数据库密钥获取

### 1.1 触发方式

在 WeTrace 界面的初始配置页面，点击「获取数据库密钥」按钮即可启动自动获取流程。

### 1.2 自动获取流程

系统会按以下步骤自动完成密钥提取：

**第一步：检测微信进程**

系统检查 `Weixin.exe` 是否正在运行。如果微信正在运行，系统会先关闭现有微信进程，等待 2 秒后重新启动。

**第二步：定位微信安装路径**

系统按以下优先级自动查找微信可执行文件：

1. 用户在配置中手动指定的路径（`.env` 中的 `WXKEY_WECHAT_PATH`）
2. Windows 注册表卸载信息（`SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\WeChat`）
3. Windows 注册表 App Paths（`WeChat.exe` / `Weixin.exe`）
4. 腾讯注册表路径（`Software\Tencent\WeChat` 等多个位置）
5. 常见安装目录扫描（C/D/E/F 盘的 `Program Files\Tencent\WeChat` 等）

如果自动检测失败，界面会提示用户手动选择微信安装路径。

**第三步：启动微信并等待窗口**

系统以独立进程方式启动微信，然后通过 `EnumWindows` API 枚举所有窗口，查找标题包含「微信」、「WeChat」或「Weixin」的窗口，等待超时默认为 30 秒。

**第四步：获取微信进程 PID**

优先通过窗口句柄获取关联的进程 ID。如果窗口方式失败（例如微信最小化或处于登录界面），则回退到进程快照扫描模式，遍历系统进程列表查找 `Weixin.exe`。

**第五步：加载 DLL 并安装 Hook**

系统加载内嵌的 `wx_key.dll`（也可通过 `.env` 中的 `WXKEY_DLL_PATH` 指定自定义路径），然后调用 `InitializeHook` 将 Hook 注入到目标微信进程中。

**第六步：轮询等待密钥**

Hook 安装成功后，系统以 100 毫秒为间隔持续轮询 DLL 的 `PollKeyData` 接口，等待微信进程返回密钥数据。默认超时时间为 120 秒。在此期间，用户需要在微信中完成登录操作。

**第七步：保存密钥**

密钥获取成功后，系统自动将密钥写入 `.env` 文件的 `WECHAT_DB_KEY` 字段，同时更新内存中的配置，无需重启应用。

### 1.3 注意事项

- 获取密钥时微信会被自动重启，请确保已保存微信中的重要操作
- 需要在微信登录界面完成登录后密钥才会生成
- 如果超时失败，可以重新点击获取按钮再次尝试
- 密钥获取成功后会自动持久化，下次启动无需重新获取（除非微信更新或重装）

---

## 2. 图片密钥获取

### 2.1 触发方式

在 WeTrace 界面的初始配置页面，点击「获取图片密钥」按钮即可启动图片密钥扫描流程。

### 2.2 自动获取流程

图片密钥的获取采用持续扫描模式，最长运行 2 分钟：

**第一步：检测并启动微信**

系统检查微信是否正在运行。如果未运行，会尝试自动启动微信（与数据库密钥获取不同，图片密钥获取不会强制重启已运行的微信）。

**第二步：定位微信缓存目录**

系统自动查找微信数据缓存目录，查找顺序为：

1. 用户配置的 `WECHAT_DB_SRC_PATH`（优先）
2. 默认路径 `%USERPROFILE%\Documents\xwechat_files`

在缓存目录下，系统会扫描以 `wxid_` 开头或长度大于 5 的子目录，通过检查是否存在 `db_storage` 或 `FileStorage\Image` 子目录来判断是否为有效的微信账号目录。

**第三步：收集模板文件并计算 XOR 密钥**

系统在用户目录下搜索以 `_t.dat` 结尾的缩略图模板文件（最多收集 16 个，按日期降序排列）。通过分析这些文件末尾 2 字节与 JPEG 文件尾标记（`0xFF 0xD9`）的异或关系，计算出 XOR 密钥。

**第四步：提取加密数据**

从模板文件中查找特定签名头（`07 08 56 32 08 07`），提取偏移 `0x0F` 到 `0x1F` 处的 16 字节密文数据，用于后续 AES 密钥验证。

**第五步：内存扫描 AES 密钥**

系统打开微信进程的内存空间，遍历所有已提交的私有内存区域（跳过超过 100MB 的大区域），搜索符合 32 字节小写字母数字模式的候选密钥。对每个候选密钥，取前 16 字节作为 AES-ECB 密钥尝试解密第四步提取的密文，如果解密结果以 JPEG 文件头（`FF D8 FF`）开头，则验证通过。

**第六步：保存密钥**

密钥获取成功后，系统自动将 `IMAGE_KEY`（AES 密钥）和 `XOR_KEY` 写入 `.env` 文件，同时更新内存配置。

### 2.3 注意事项

- 图片密钥获取不需要重启微信，但需要微信已登录
- 如果首次扫描未找到密钥，系统会每 3 秒重试一次，持续最多 2 分钟
- 建议在扫描期间在微信中打开一张图片，有助于密钥出现在内存中
- 如果客户端断开连接（如关闭浏览器），扫描会自动停止

---

## 3. 数据库解密

### 3.1 触发方式

在 WeTrace 界面点击「解密数据库」按钮，或通过 API 调用 `/api/decrypt` 接口触发解密。

### 3.2 解密流程

**前置条件：**
- 已获取数据库密钥（`WECHAT_DB_KEY` 已配置）
- 已配置微信数据存储路径（`WECHAT_DB_SRC_PATH`）

**解密步骤：**

1. 系统在 `WECHAT_DB_SRC_PATH` 下的 `db_storage` 子目录中扫描所有 `.db` 文件（排除 FTS 索引文件）
2. 如果 `db_storage` 中未找到数据库文件，会回退到直接扫描 `WECHAT_DB_SRC_PATH` 目录
3. 将 64 位十六进制密钥字符串解码为 32 字节二进制密钥
4. 对每个数据库文件执行解密，最多 8 个文件并行处理
5. 解密后的文件保存到 `data/` 目录，保持原始目录结构
6. 解密完成后自动触发数据存储重载，新数据立即可用

### 3.3 解密算法详情

微信数据库使用 SQLCipher 加密方案，具体参数如下：

| 参数 | 值 |
|------|-----|
| 页大小 | 4096 字节 |
| 盐值长度 | 16 字节（首页前 16 字节） |
| 密钥派生 | PBKDF2-HMAC-SHA512，迭代 256000 次 |
| 加密算法 | AES-256-CBC |
| HMAC 校验 | HMAC-SHA512 |
| 保留区域 | 80 字节（16 字节 IV + 64 字节 HMAC） |

解密过程：
1. 从首页提取 16 字节盐值
2. 使用 PBKDF2 从用户密钥和盐值派生 32 字节加密密钥
3. 将盐值每字节异或 `0x3A` 生成 MAC 盐值，再用 PBKDF2（2 次迭代）派生 MAC 密钥
4. 对每页验证 HMAC 签名，确保数据完整性
5. 使用 AES-256-CBC 解密页面数据
6. 首页解密后替换为标准 SQLite 文件头（`SQLite format 3\0`）

### 3.4 注意事项

- 如果数据库文件已经是未加密的 SQLite 格式（文件头为 `SQLite format 3`），系统会直接复制而不解密
- 全零页面会被原样保留
- 解密失败的单个文件不会阻止其他文件的解密
- 解密完成后界面会显示成功解密的文件数量

---

## 4. 环境变量配置参考

以下是与密钥和解密相关的 `.env` 配置项：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| `WECHAT_DB_KEY` | 数据库解密密钥（64 位十六进制） | 自动获取后填入 |
| `IMAGE_KEY` | 图片 AES 解密密钥 | 自动获取后填入 |
| `XOR_KEY` | 图片 XOR 密钥（十六进制） | 自动获取后填入 |
| `WECHAT_DB_SRC_PATH` | 微信数据存储路径 | `C:\Users\xxx\Documents\xwechat_files\wxid_xxx` |
| `WXKEY_WECHAT_PATH` | 微信可执行文件路径（可选） | `C:\Program Files\Tencent\WeChat\WeChat.exe` |
| `WXKEY_DLL_PATH` | 自定义 DLL 路径（可选） | 默认使用内嵌 DLL |

---

## 5. 常见问题

**Q: 获取密钥时提示「未找到微信安装路径」？**

A: 请在设置页面手动选择微信的安装路径，或在 `.env` 文件中配置 `WXKEY_WECHAT_PATH`。

**Q: 获取密钥超时？**

A: 请确保在超时时间内完成微信登录。如果微信已登录但仍超时，可能是微信版本不兼容，请尝试更新微信或 WeTrace。

**Q: 解密后数据为空？**

A: 请检查 `WECHAT_DB_SRC_PATH` 是否指向正确的微信账号数据目录（应包含 `db_storage` 子目录）。

**Q: 图片密钥获取失败？**

A: 请确保微信已登录，并在扫描期间在微信中打开至少一张图片。图片密钥需要微信在内存中加载解密组件后才能提取。
