# 监控告警

WeTrace 提供消息监控功能，支持关键词匹配和 AI 智能监控两种模式，当检测到匹配消息时自动通过 Webhook 或飞书推送告警通知。

---

## 1. 进入监控配置

在左侧导航栏点击「监控配置」进入监控管理页面。页面分为两个区域：

- 上方：监控规则列表（创建、编辑、删除、测试规则）
- 下方：飞书平台全局配置

---

## 2. 创建监控规则

### 2.1 新建规则

点击监控规则列表右上角的「新建」按钮，打开规则配置表单。

### 2.2 填写规则名称

在「配置名称」输入框中填写一个易于识别的名称，例如「敏感词监控」或「客户投诉检测」。名称不能为空。

### 2.3 选择监控类型

点击对应按钮选择监控类型：

**关键词匹配（keyword）：**

- 选择后会出现「敏感词列表」区域
- 在输入框中输入敏感词，按回车或点击「添加」按钮添加
- 已添加的关键词会以标签形式展示，点击标签上的关闭图标可删除
- 匹配规则：不区分大小写，消息内容包含任一关键词即触发告警

**AI 智能监控（ai）：**

- 选择后会出现「AI 提示词」文本框
- 填写用于判断消息是否需要告警的提示词
- 例如：「判断以下消息是否包含负面情绪或投诉内容」
- AI 会将提示词作为 system 角色，消息内容作为 user 角色发送给大模型
- 当 AI 返回结果中包含「yes」、「是」或「匹配」时，视为命中告警
- 需要先在「设置」页面配置并启用 AI 功能

### 2.4 选择推送平台

点击对应按钮选择告警推送平台：

| 平台 | 说明 |
|------|------|
| Webhook | 通用 HTTP POST 推送，适合自建系统对接 |
| 飞书 | 通过飞书机器人 Webhook 推送消息卡片 |

- 选择 Webhook 后，需要填写「Webhook URL」
- 选择飞书后，需要填写「飞书机器人 Webhook URL」（也可使用飞书全局配置中的地址）

### 2.5 选择监控会话

在「监控会话」区域选择需要监控的会话：

- 会话列表展示所有已解密的聊天会话
- 支持搜索过滤（按昵称、备注、微信号搜索）
- 勾选需要监控的会话
- 未选择任何会话时，该规则不会执行检查（不会全量扫描）
- 列表上方显示已选择的会话数量

### 2.6 设置检查间隔

在「检查间隔（分钟）」输入框中设置监控频率：

- 最小值：1 分钟
- 最大值：1440 分钟（24 小时）
- 默认值：5 分钟
- 系统每分钟轮询一次，判断各规则是否到达检查时间

### 2.7 启用/禁用规则

通过「启用」开关控制规则是否生效。禁用的规则不会参与定时检查。

### 2.8 保存规则

填写完成后点击「保存」按钮。新建规则会分配唯一 ID 并持久化到本地 JSON 文件。

---

## 3. 规则管理

### 3.1 规则列表

监控规则列表中，每条规则显示以下信息：

- 规则名称
- 启用状态标签（绿色「已启用」/ 灰色「已禁用」）
- 监控类型（关键词 / AI）
- 推送平台（Webhook / 飞书）
- 关键词预览（关键词类型时显示前 3 个关键词）

### 3.2 编辑规则

点击规则右侧的编辑图标（铅笔），打开编辑表单，修改后点击「保存」。编辑时会保留原有的创建时间，更新修改时间。

### 3.3 删除规则

点击规则右侧的删除图标（垃圾桶），直接删除该规则。删除操作不可撤销。

### 3.4 启用/禁用规则

编辑规则时可通过「启用」开关切换规则状态。禁用后规则保留但不参与检查。

---

## 4. 测试推送

### 4.1 测试单条规则

在规则列表中，点击规则右侧的发送图标，可以测试该规则的推送连通性：

- 测试时按钮显示加载动画
- 成功后显示绿色对勾图标
- 失败后显示红色叉号图标
- 测试会向规则配置的推送地址发送一条测试消息

### 4.2 Webhook 测试

对于 Webhook 平台的规则，测试会发送以下格式的 JSON 数据：

```json
{
  "event": "test",
  "timestamp": 1700000000,
  "message": {
    "content": "WeTrace Webhook 连通性测试",
    "time": "2025-01-01 12:00:00"
  }
}
```

系统会检查 HTTP 响应状态码，2xx 范围视为成功。

### 4.3 飞书测试

对于飞书平台的规则，测试会通过飞书机器人 Webhook 发送一条富文本卡片消息。如果配置了签名密钥，测试消息也会携带签名。

---

## 5. 监控运行机制

### 5.1 检查流程

监控检查器启动后，按以下流程运行：

1. 系统每 1 分钟轮询一次所有已启用的监控规则
2. 对每条规则，判断距上次检查是否已超过设定的间隔时间
3. 到达检查时间的规则，查询其监控会话在上次检查到当前时间范围内的新文本消息
4. 每条消息最多查询 500 条，跳过自己发送的消息
5. 根据规则类型（关键词/AI）对每条消息进行匹配判断
6. 命中的消息触发告警推送
7. 更新规则的上次检查时间

### 5.2 告警推送内容

当消息命中监控规则时，推送的告警信息包含：

| 字段 | 说明 |
|------|------|
| `talker` | 会话 ID |
| `talker_name` | 会话名称 |
| `sender` | 发送人 ID |
| `sender_name` | 发送人昵称 |
| `content` | 消息内容 |
| `time` | 消息时间 |
| `is_chatroom` | 是否为群聊消息 |

告警标题格式为：`规则名称 (匹配信息)`，例如「敏感词监控 (关键词: 退款)」或「投诉检测 (AI判定: 是)」。

### 5.3 数据持久化

监控配置存储在 `data/monitor_configs.json` 文件中，包含：

- 所有监控规则及其状态
- 飞书全局配置
- 自增 ID 计数器

应用重启后会自动加载已保存的配置并恢复监控。

---

## 6. 常见问题

**Q: 监控只检查文本消息吗？**

A: 是的，当前版本仅检查文本类型的消息，不包括图片、语音、视频等其他类型。

**Q: AI 监控需要什么前置条件？**

A: 需要在「设置」页面配置并启用 AI 大模型功能（填写 API Key、Base URL、模型名称）。AI 监控会对每条消息调用大模型进行判断，请注意 API 调用量和费用。

**Q: 规则的推送地址为空会怎样？**

A: 如果推送地址为空，测试推送时会提示「推送地址为空，无法测试」。实际监控时，飞书平台会回退到全局飞书配置中的 Webhook 地址；Webhook 平台则会跳过推送。

**Q: 监控功能处于什么阶段？**

A: 当前监控模块处于早期版本，主要支持核心规则配置和推送功能。更多高级功能（如监控历史回溯、图形化分析看板等）将在后续版本中上线。
